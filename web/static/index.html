<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SongGeneration Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- WaveSurfer.js for waveform visualization -->
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.esm.js" type="module"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1e1e1e;
            font-family: 'Inter', -apple-system, sans-serif;
            color: #e0e0e0;
            min-height: 100vh;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a4a4a; }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #3a3a3a;
            border-radius: 2px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #10B981;
            border-radius: 50%;
            cursor: pointer;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        textarea::placeholder, input::placeholder {
            color: #555;
        }

        /* Add Section Popup - fixed position */
        .add-section-popup {
            position: fixed;
            background-color: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 8px;
            z-index: 10000;
            min-width: 160px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }

        .add-section-popup button {
            display: block;
            width: 100%;
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            text-align: left;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.15s;
        }

        .add-section-popup button:hover {
            background-color: #3a3a3a;
        }

        /* Indeterminate progress bar animation */
        @keyframes indeterminate {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(400%);
            }
        }

        .progress-bar-indeterminate {
            position: relative;
            overflow: hidden;
            background: #333;
        }

        .progress-bar-indeterminate::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 30%;
            height: 100%;
            background: linear-gradient(90deg, transparent, #10B981, transparent);
            animation: indeterminate 1.5s ease-in-out infinite;
        }

        /* Waveform trimmer styles */
        .waveform-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }

        .waveform-container canvas {
            border-radius: 4px;
        }

        /* Custom select dropdown - remove default arrow */
        .custom-select {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background-image: none !important;
        }
        .custom-select::-ms-expand {
            display: none !important;
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const SECTION_TYPES = {
    'intro': { name: 'Intro', color: '#8B5CF6', hasLyrics: false, hasDuration: true },
    'verse': { name: 'Verse', color: '#3B82F6', hasLyrics: true, hasDuration: false },
    'chorus': { name: 'Chorus', color: '#F59E0B', hasLyrics: true, hasDuration: false },
    'bridge': { name: 'Bridge', color: '#EC4899', hasLyrics: true, hasDuration: false },
    'inst': { name: 'Inst', color: '#10B981', hasLyrics: false, hasDuration: true },
    'outro': { name: 'Outro', color: '#EAB308', hasLyrics: false, hasDuration: true },
};

// Custom dark audio player component
const DarkAudioPlayer = ({ src }) => {
    const audioRef = useRef(null);
    const [isPlaying, setIsPlaying] = useState(false);
    const [currentTime, setCurrentTime] = useState(0);
    const [duration, setDuration] = useState(0);
    const [volume, setVolume] = useState(1);

    const formatTime = (time) => {
        if (!time || isNaN(time)) return '0:00';
        const mins = Math.floor(time / 60);
        const secs = Math.floor(time % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    const togglePlay = () => {
        if (audioRef.current) {
            if (isPlaying) {
                audioRef.current.pause();
            } else {
                audioRef.current.play();
            }
            setIsPlaying(!isPlaying);
        }
    };

    const handleTimeUpdate = () => {
        if (audioRef.current) {
            setCurrentTime(audioRef.current.currentTime);
        }
    };

    const handleLoadedMetadata = () => {
        if (audioRef.current) {
            setDuration(audioRef.current.duration);
        }
    };

    const handleSeek = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        if (audioRef.current) {
            audioRef.current.currentTime = percent * duration;
        }
    };

    const handleEnded = () => {
        setIsPlaying(false);
        setCurrentTime(0);
    };

    const progress = duration > 0 ? (currentTime / duration) * 100 : 0;

    return (
        <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            backgroundColor: '#1a1a1a',
            borderRadius: '8px',
            padding: '10px 14px',
            flex: 1,
        }}>
            <audio
                ref={audioRef}
                src={src}
                onTimeUpdate={handleTimeUpdate}
                onLoadedMetadata={handleLoadedMetadata}
                onEnded={handleEnded}
                onPlay={() => setIsPlaying(true)}
                onPause={() => setIsPlaying(false)}
            />

            {/* Play/Pause button */}
            <button
                onClick={togglePlay}
                style={{
                    width: '32px',
                    height: '32px',
                    borderRadius: '50%',
                    border: 'none',
                    backgroundColor: '#10B981',
                    color: '#fff',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0,
                }}
            >
                {isPlaying ? (
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                        <rect x="2" y="1" width="3" height="10" rx="1" />
                        <rect x="7" y="1" width="3" height="10" rx="1" />
                    </svg>
                ) : (
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                        <path d="M2 1.5v9l8-4.5-8-4.5z" />
                    </svg>
                )}
            </button>

            {/* Time */}
            <span style={{ fontSize: '12px', color: '#888', minWidth: '70px' }}>
                {formatTime(currentTime)} / {formatTime(duration)}
            </span>

            {/* Progress bar */}
            <div
                onClick={handleSeek}
                style={{
                    flex: 1,
                    height: '6px',
                    backgroundColor: '#333',
                    borderRadius: '3px',
                    cursor: 'pointer',
                    position: 'relative',
                }}
            >
                <div style={{
                    width: `${progress}%`,
                    height: '100%',
                    backgroundColor: '#10B981',
                    borderRadius: '3px',
                    transition: 'width 0.1s',
                }} />
            </div>

            {/* Volume */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#666">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                </svg>
                <input
                    type="range"
                    min="0"
                    max="1"
                    step="0.1"
                    value={volume}
                    onChange={(e) => {
                        const v = parseFloat(e.target.value);
                        setVolume(v);
                        if (audioRef.current) audioRef.current.volume = v;
                    }}
                    style={{ width: '60px', height: '4px' }}
                />
            </div>
        </div>
    );
};

// Audio Trimmer Component with Waveform Visualization
const AudioTrimmer = ({ onAccept, onClear, onFileLoad }) => {
    const [file, setFile] = useState(null);
    const [clipDuration, setClipDuration] = useState(10);
    const [regionStart, setRegionStart] = useState(0);
    const [totalDuration, setTotalDuration] = useState(0);
    const [isPlaying, setIsPlaying] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [isAccepted, setIsAccepted] = useState(false);
    const [isExpanded, setIsExpanded] = useState(false);
    const [waveformPeaks, setWaveformPeaks] = useState([]);
    const [isDragging, setIsDragging] = useState(false);
    const [error, setError] = useState(null);

    const waveformRef = useRef(null);
    const wavesurferRef = useRef(null);
    const regionRef = useRef(null);
    const fileInputRef = useRef(null);
    const audioContextRef = useRef(null);
    const audioBufferRef = useRef(null);
    const playIntervalRef = useRef(null);

    // Handle drag/click on waveform to move selection
    const handleWaveformInteraction = (e, containerRef, padding = 12) => {
        if (totalDuration <= 0 || isLoading) return;
        const rect = containerRef.getBoundingClientRect();
        const clickX = e.clientX - rect.left - padding;
        const containerWidth = rect.width - (padding * 2);
        const clickPercent = Math.max(0, Math.min(1, clickX / containerWidth));
        const clickTime = clickPercent * totalDuration;
        const newStart = Math.max(0, Math.min(totalDuration - clipDuration, clickTime - clipDuration / 2));
        setRegionStart(newStart);
    };

    const handleMouseDown = (e, containerRef, padding) => {
        setIsDragging(true);
        handleWaveformInteraction(e, containerRef, padding);
    };

    const handleMouseMove = (e, containerRef, padding) => {
        if (!isDragging) return;
        handleWaveformInteraction(e, containerRef, padding);
    };

    const handleMouseUp = () => {
        setIsDragging(false);
    };

    // Global mouse up listener to stop dragging
    useEffect(() => {
        const handleGlobalMouseUp = () => setIsDragging(false);
        window.addEventListener('mouseup', handleGlobalMouseUp);
        return () => window.removeEventListener('mouseup', handleGlobalMouseUp);
    }, []);

    const formatTime = (seconds) => {
        if (!seconds || isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    // Initialize WaveSurfer when file is loaded
    useEffect(() => {
        if (!file || !waveformRef.current) return;

        setIsLoading(true);
        setError(null);

        // Clean up previous instance
        if (wavesurferRef.current) {
            wavesurferRef.current.destroy();
        }

        // Create WaveSurfer instance
        const ws = WaveSurfer.create({
            container: waveformRef.current,
            waveColor: '#4a4a4a',
            progressColor: '#4a4a4a',  // Same as waveColor - we use overlay for selection
            cursorColor: 'transparent',  // Hide cursor - we use our own selection overlay
            cursorWidth: 0,
            height: 80,
            barWidth: 2,
            barGap: 1,
            barRadius: 2,
            normalize: true,
            backend: 'WebAudio',
            interact: false,  // Disable WaveSurfer's own click handling
        });

        wavesurferRef.current = ws;

        // Load audio file
        const url = URL.createObjectURL(file);
        ws.load(url);

        ws.on('ready', async () => {
            setIsLoading(false);
            const duration = ws.getDuration();
            setTotalDuration(duration);

            // Set initial clip duration (min of user preference or total duration)
            const initialClipDuration = Math.min(clipDuration, duration);
            setClipDuration(initialClipDuration);
            setRegionStart(0);

            // Decode audio directly from file for full quality (don't use WaveSurfer's decoded data)
            try {
                if (!audioContextRef.current) {
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                const arrayBuffer = await file.arrayBuffer();
                const decodedBuffer = await audioContextRef.current.decodeAudioData(arrayBuffer);
                audioBufferRef.current = decodedBuffer;
                console.log(`Audio decoded: ${decodedBuffer.sampleRate}Hz, ${decodedBuffer.numberOfChannels}ch, ${decodedBuffer.length} samples`);

                // Extract waveform peaks for visualization (200 bars)
                const numBars = 200;
                const channelData = decodedBuffer.getChannelData(0); // Use first channel
                const samplesPerBar = Math.floor(channelData.length / numBars);
                const peaks = [];
                for (let i = 0; i < numBars; i++) {
                    let max = 0;
                    const start = i * samplesPerBar;
                    for (let j = 0; j < samplesPerBar; j++) {
                        const val = Math.abs(channelData[start + j] || 0);
                        if (val > max) max = val;
                    }
                    peaks.push(max);
                }
                // Normalize peaks to 0-100
                const maxPeak = Math.max(...peaks, 0.01);
                const normalizedPeaks = peaks.map(p => (p / maxPeak) * 100);
                setWaveformPeaks(normalizedPeaks);
            } catch (err) {
                console.error('Failed to decode audio:', err);
                // Fallback to WaveSurfer's decoded data
                if (ws.getDecodedData()) {
                    audioBufferRef.current = ws.getDecodedData();
                }
            }
        });

        ws.on('error', (err) => {
            setIsLoading(false);
            setError('Failed to load audio file');
            console.error('WaveSurfer error:', err);
        });

        ws.on('finish', () => {
            setIsPlaying(false);
        });

        return () => {
            URL.revokeObjectURL(url);
            if (wavesurferRef.current) {
                wavesurferRef.current.destroy();
                wavesurferRef.current = null;
            }
        };
    }, [file]);

    // Handle file selection
    const handleFileSelect = async (e) => {
        const selectedFile = e.target.files?.[0];
        if (!selectedFile) return;

        // Validate file type
        const validTypes = ['audio/wav', 'audio/mp3', 'audio/mpeg', 'audio/flac', 'audio/ogg'];
        if (!validTypes.includes(selectedFile.type) && !selectedFile.name.match(/\.(wav|mp3|flac|ogg)$/i)) {
            setError('Please select a valid audio file (WAV, MP3, FLAC, or OGG)');
            return;
        }

        setFile(selectedFile);
        setIsAccepted(false);
        setRegionStart(0);
        if (onFileLoad) onFileLoad(true);  // Notify parent that a file is loaded
    };

    // Stop playback helper
    const stopPlayback = () => {
        if (playIntervalRef.current) {
            clearInterval(playIntervalRef.current);
            playIntervalRef.current = null;
        }
        if (wavesurferRef.current) {
            wavesurferRef.current.pause();
        }
        setIsPlaying(false);
    };

    // Preview selected region only
    const handlePreview = () => {
        if (!wavesurferRef.current) return;

        if (isPlaying) {
            stopPlayback();
        } else {
            // Clear any existing interval
            if (playIntervalRef.current) {
                clearInterval(playIntervalRef.current);
            }

            // Seek to region start and play
            wavesurferRef.current.setTime(regionStart);
            wavesurferRef.current.play();
            setIsPlaying(true);

            // Stop at region end
            playIntervalRef.current = setInterval(() => {
                if (wavesurferRef.current) {
                    const currentTime = wavesurferRef.current.getCurrentTime();
                    if (currentTime >= regionStart + clipDuration || !wavesurferRef.current.isPlaying()) {
                        stopPlayback();
                    }
                }
            }, 50);
        }
    };

    // Audio buffer to WAV conversion - 32-bit float for best quality
    const audioBufferToWav = (buffer) => {
        const numChannels = buffer.numberOfChannels;
        const sampleRate = buffer.sampleRate;
        const format = 3; // IEEE float
        const bitDepth = 32;

        const bytesPerSample = bitDepth / 8;
        const blockAlign = numChannels * bytesPerSample;
        const byteRate = sampleRate * blockAlign;
        const dataSize = buffer.length * blockAlign;
        const headerSize = 44;
        const totalSize = headerSize + dataSize;

        const arrayBuffer = new ArrayBuffer(totalSize);
        const view = new DataView(arrayBuffer);

        // WAV header
        const writeString = (offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        writeString(0, 'RIFF');
        view.setUint32(4, totalSize - 8, true);
        writeString(8, 'WAVE');
        writeString(12, 'fmt ');
        view.setUint32(16, 16, true); // fmt chunk size
        view.setUint16(20, format, true); // 3 = IEEE float
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitDepth, true);
        writeString(36, 'data');
        view.setUint32(40, dataSize, true);

        // Write interleaved audio data as 32-bit float (no conversion loss)
        const channels = [];
        for (let ch = 0; ch < numChannels; ch++) {
            channels.push(buffer.getChannelData(ch));
        }

        let offset = 44;
        for (let i = 0; i < buffer.length; i++) {
            for (let ch = 0; ch < numChannels; ch++) {
                view.setFloat32(offset, channels[ch][i], true);
                offset += 4;
            }
        }

        return new Blob([arrayBuffer], { type: 'audio/wav' });
    };

    // Trim and accept
    const handleAccept = async () => {
        // Stop playback first
        stopPlayback();

        if (!audioBufferRef.current) {
            setError('Audio not loaded yet');
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const sourceBuffer = audioBufferRef.current;
            const sampleRate = sourceBuffer.sampleRate;
            const startSample = Math.floor(regionStart * sampleRate);
            const numSamples = Math.floor(clipDuration * sampleRate);

            // Create AudioContext for creating new buffer
            if (!audioContextRef.current) {
                audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Create trimmed buffer
            const trimmedBuffer = audioContextRef.current.createBuffer(
                sourceBuffer.numberOfChannels,
                numSamples,
                sampleRate
            );

            // Copy samples
            for (let ch = 0; ch < sourceBuffer.numberOfChannels; ch++) {
                const src = sourceBuffer.getChannelData(ch);
                const dst = trimmedBuffer.getChannelData(ch);
                for (let i = 0; i < numSamples && (startSample + i) < src.length; i++) {
                    dst[i] = src[startSample + i];
                }
            }

            // Convert to WAV blob
            const wavBlob = audioBufferToWav(trimmedBuffer);

            // Upload to server
            const formData = new FormData();
            formData.append('file', wavBlob, `trimmed_${file.name.replace(/\.[^.]+$/, '')}.wav`);

            const response = await fetch('/api/upload-reference', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(await response.text());
            }

            const data = await response.json();
            setIsAccepted(true);
            setIsLoading(false);

            // Call onAccept with the reference ID and metadata
            onAccept({
                id: data.id,
                fileName: file.name,
                clipStart: regionStart,
                clipDuration: clipDuration
            });
        } catch (err) {
            setError(err.message || 'Failed to process audio');
            setIsLoading(false);
        }
    };

    // Clear everything
    const handleClear = () => {
        if (wavesurferRef.current) {
            wavesurferRef.current.destroy();
            wavesurferRef.current = null;
        }
        setFile(null);
        setIsAccepted(false);
        setRegionStart(0);
        setTotalDuration(0);
        setError(null);
        audioBufferRef.current = null;
        if (onFileLoad) onFileLoad(false);  // Notify parent that file is cleared
        onClear();
    };

    // Update region when duration changes
    const handleDurationChange = (newDuration) => {
        const maxDuration = Math.min(newDuration, totalDuration);
        setClipDuration(maxDuration);

        // Adjust start if region would exceed total duration
        if (regionStart + maxDuration > totalDuration) {
            setRegionStart(Math.max(0, totalDuration - maxDuration));
        }
    };

    // Handle region drag via slider
    const handleRegionSlide = (newStart) => {
        const maxStart = Math.max(0, totalDuration - clipDuration);
        setRegionStart(Math.min(newStart, maxStart));
    };

    // Render upload state
    if (!file) {
        return (
            <div>
                <input
                    ref={fileInputRef}
                    type="file"
                    accept="audio/*"
                    onChange={handleFileSelect}
                    style={{ display: 'none' }}
                />
                <button
                    onClick={() => fileInputRef.current?.click()}
                    style={{
                        width: '100%',
                        padding: '20px',
                        borderRadius: '10px',
                        border: '2px dashed #3a3a3a',
                        backgroundColor: 'transparent',
                        color: '#666',
                        fontSize: '13px',
                        cursor: 'pointer',
                        transition: 'border-color 0.2s',
                    }}
                    onMouseOver={e => e.target.style.borderColor = '#10B981'}
                    onMouseOut={e => e.target.style.borderColor = '#3a3a3a'}
                >
                    Click to upload reference audio
                </button>
                {error && <div style={{ color: '#EF4444', fontSize: '12px', marginTop: '8px' }}>{error}</div>}
            </div>
        );
    }

    // Render accepted state
    if (isAccepted) {
        return (
            <div style={{
                backgroundColor: '#1e1e1e',
                borderRadius: '10px',
                padding: '14px',
                border: '1px solid #10B981',
            }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <span style={{ fontSize: '18px' }}>&#x2713;</span>
                        <div>
                            <div style={{ fontSize: '13px', color: '#e0e0e0' }}>{file.name}</div>
                            <div style={{ fontSize: '11px', color: '#10B981' }}>
                                {formatTime(regionStart)} - {formatTime(regionStart + clipDuration)} ({clipDuration}s clip)
                            </div>
                        </div>
                    </div>
                    <button
                        onClick={handleClear}
                        style={{
                            background: 'transparent',
                            border: 'none',
                            color: '#666',
                            cursor: 'pointer',
                            fontSize: '16px',
                            padding: '4px 8px',
                        }}
                    >x</button>
                </div>
            </div>
        );
    }

    // Render trimmer UI
    return (
        <div>
            {/* File info */}
            <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                backgroundColor: '#1e1e1e',
                padding: '10px 14px',
                borderRadius: '10px',
                marginBottom: '12px',
            }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <span style={{ fontSize: '16px' }}>&#x1F3B5;</span>
                    <span style={{ fontSize: '13px', color: '#e0e0e0', maxWidth: '180px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                        {file.name}
                    </span>
                </div>
                <button
                    onClick={handleClear}
                    style={{
                        background: 'transparent',
                        border: 'none',
                        color: '#666',
                        cursor: 'pointer',
                        fontSize: '16px',
                    }}
                >x</button>
            </div>

            {/* Duration input */}
            <div style={{ marginBottom: '12px' }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '6px' }}>
                    <span style={{ fontSize: '12px', color: '#666' }}>Clip Duration</span>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <input
                            type="number"
                            min="1"
                            max={Math.floor(totalDuration) || 60}
                            value={clipDuration}
                            onChange={e => handleDurationChange(parseInt(e.target.value) || 1)}
                            style={{
                                width: '50px',
                                backgroundColor: '#1e1e1e',
                                border: '1px solid #3a3a3a',
                                borderRadius: '6px',
                                padding: '6px 8px',
                                color: '#10B981',
                                fontSize: '13px',
                                textAlign: 'center',
                                outline: 'none',
                            }}
                        />
                        <span style={{ fontSize: '12px', color: '#666' }}>seconds</span>
                    </div>
                </div>
            </div>

            {/* Waveform container - click to move selection */}
            <div style={{ position: 'relative' }}>
                {/* Expand button */}
                {totalDuration > 0 && !isLoading && (
                    <button
                        onClick={() => setIsExpanded(true)}
                        style={{
                            position: 'absolute',
                            top: '8px',
                            right: '8px',
                            zIndex: 5,
                            background: 'rgba(0,0,0,0.5)',
                            border: '1px solid #3a3a3a',
                            borderRadius: '6px',
                            padding: '6px 10px',
                            color: '#888',
                            fontSize: '11px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '4px',
                            transition: 'all 0.2s',
                        }}
                        onMouseOver={e => { e.currentTarget.style.color = '#10B981'; e.currentTarget.style.borderColor = '#10B981'; }}
                        onMouseOut={e => { e.currentTarget.style.color = '#888'; e.currentTarget.style.borderColor = '#3a3a3a'; }}
                    >
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                        </svg>
                        Expand
                    </button>
                )}

                <div
                    className="waveform-container"
                    style={{
                        position: 'relative',
                        overflow: 'hidden',
                        cursor: totalDuration > 0 ? (isDragging ? 'grabbing' : 'pointer') : 'default',
                        userSelect: 'none',
                    }}
                    onMouseDown={(e) => handleMouseDown(e, e.currentTarget, 12)}
                    onMouseMove={(e) => handleMouseMove(e, e.currentTarget, 12)}
                    onMouseUp={handleMouseUp}
                    onMouseLeave={handleMouseUp}
                >
                    {isLoading && (
                        <div style={{
                            position: 'absolute',
                            top: 0, left: 0, right: 0, bottom: 0,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            backgroundColor: 'rgba(26, 26, 26, 0.8)',
                            borderRadius: '8px',
                            zIndex: 10,
                        }}>
                            <span style={{ color: '#10B981', fontSize: '13px' }}>Loading...</span>
                        </div>
                    )}

                    {/* Waveform wrapper with selection overlay */}
                    <div style={{ position: 'relative' }}>
                        <div ref={waveformRef} />

                        {/* Region overlay visualization - positioned over the waveform */}
                        {totalDuration > 0 && !isLoading && (
                            <div style={{
                                position: 'absolute',
                                top: 0,
                                left: `${(regionStart / totalDuration) * 100}%`,
                                width: `${(clipDuration / totalDuration) * 100}%`,
                                height: '100%',
                                backgroundColor: 'rgba(16, 185, 129, 0.25)',
                                borderLeft: '2px solid #10B981',
                                borderRight: '2px solid #10B981',
                                pointerEvents: 'none',
                                boxSizing: 'border-box',
                            }} />
                        )}
                    </div>
                </div>
            </div>

            {/* Expanded waveform popup */}
            {isExpanded && (
                <div
                    style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                        zIndex: 9999,
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '40px',
                        animation: 'fadeIn 0.2s ease-out',
                    }}
                    onClick={(e) => {
                        if (e.target === e.currentTarget) setIsExpanded(false);
                    }}
                >
                    <style>{`
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes slideUp {
                            from { opacity: 0; transform: translateY(20px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                    `}</style>

                    <div style={{
                        width: '100%',
                        maxWidth: '1200px',
                        backgroundColor: '#1e1e1e',
                        borderRadius: '16px',
                        padding: '24px',
                        animation: 'slideUp 0.3s ease-out',
                    }}>
                        {/* Header */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <div>
                                <div style={{ fontSize: '16px', fontWeight: '600', color: '#e0e0e0' }}>{file?.name}</div>
                                <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                                    Click on the waveform to position your {clipDuration}s selection
                                </div>
                            </div>
                            <button
                                onClick={() => setIsExpanded(false)}
                                style={{
                                    background: 'transparent',
                                    border: '1px solid #3a3a3a',
                                    borderRadius: '8px',
                                    padding: '8px 16px',
                                    color: '#888',
                                    fontSize: '13px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                }}
                            >
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                                Close
                            </button>
                        </div>

                        {/* Large waveform */}
                        <div
                            style={{
                                backgroundColor: '#1a1a1a',
                                borderRadius: '12px',
                                padding: '20px',
                                cursor: totalDuration > 0 ? (isDragging ? 'grabbing' : 'pointer') : 'default',
                                position: 'relative',
                                userSelect: 'none',
                            }}
                            onMouseDown={(e) => handleMouseDown(e, e.currentTarget, 20)}
                            onMouseMove={(e) => handleMouseMove(e, e.currentTarget, 20)}
                            onMouseUp={handleMouseUp}
                            onMouseLeave={handleMouseUp}
                        >
                            {/* Real waveform visualization for expanded view */}
                            <div style={{ height: '120px', position: 'relative' }}>
                                {/* Waveform bars from actual audio data */}
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    height: '100%',
                                    gap: '1px',
                                }}>
                                    {waveformPeaks.map((peak, i) => {
                                        const pos = i / waveformPeaks.length;
                                        const inSelection = pos >= (regionStart / totalDuration) && pos <= ((regionStart + clipDuration) / totalDuration);
                                        return (
                                            <div
                                                key={i}
                                                style={{
                                                    flex: 1,
                                                    height: `${Math.max(5, peak)}%`,
                                                    backgroundColor: inSelection ? '#10B981' : '#4a4a4a',
                                                    borderRadius: '1px',
                                                }}
                                            />
                                        );
                                    })}
                                </div>

                                {/* Selection overlay */}
                                <div style={{
                                    position: 'absolute',
                                    top: 0,
                                    left: `${(regionStart / totalDuration) * 100}%`,
                                    width: `${(clipDuration / totalDuration) * 100}%`,
                                    height: '100%',
                                    backgroundColor: 'rgba(16, 185, 129, 0.15)',
                                    borderLeft: '3px solid #10B981',
                                    borderRight: '3px solid #10B981',
                                    pointerEvents: 'none',
                                    boxSizing: 'border-box',
                                }} />
                            </div>

                            {/* Time markers */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '12px' }}>
                                <span style={{ fontSize: '11px', color: '#666' }}>0:00</span>
                                <span style={{ fontSize: '11px', color: '#666' }}>{formatTime(totalDuration / 2)}</span>
                                <span style={{ fontSize: '11px', color: '#666' }}>{formatTime(totalDuration)}</span>
                            </div>
                        </div>

                        {/* Selection info and controls */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '20px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
                                {/* Clip duration input */}
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <span style={{ fontSize: '13px', color: '#888' }}>Clip Duration:</span>
                                    <input
                                        type="number"
                                        min="1"
                                        max={Math.floor(totalDuration) || 60}
                                        value={clipDuration}
                                        onChange={e => handleDurationChange(parseInt(e.target.value) || 1)}
                                        style={{
                                            width: '60px',
                                            backgroundColor: '#2a2a2a',
                                            border: '1px solid #3a3a3a',
                                            borderRadius: '6px',
                                            padding: '8px 10px',
                                            color: '#10B981',
                                            fontSize: '14px',
                                            textAlign: 'center',
                                            outline: 'none',
                                        }}
                                    />
                                    <span style={{ fontSize: '13px', color: '#888' }}>sec</span>
                                </div>
                                {/* Selection time display */}
                                <div style={{ fontSize: '14px', color: '#10B981', fontWeight: '500' }}>
                                    Selection: {formatTime(regionStart)} - {formatTime(regionStart + clipDuration)}
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    onClick={handlePreview}
                                    style={{
                                        padding: '10px 20px',
                                        borderRadius: '8px',
                                        border: '1px solid #3a3a3a',
                                        backgroundColor: '#2a2a2a',
                                        color: isPlaying ? '#10B981' : '#e0e0e0',
                                        fontSize: '13px',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                    }}
                                >
                                    {isPlaying ? (
                                        <>
                                            <svg width="14" height="14" viewBox="0 0 12 12" fill="currentColor">
                                                <rect x="2" y="1" width="3" height="10" rx="1" />
                                                <rect x="7" y="1" width="3" height="10" rx="1" />
                                            </svg>
                                            Stop
                                        </>
                                    ) : (
                                        <>
                                            <svg width="14" height="14" viewBox="0 0 12 12" fill="currentColor">
                                                <path d="M2 1.5v9l8-4.5-8-4.5z" />
                                            </svg>
                                            Preview
                                        </>
                                    )}
                                </button>
                                <button
                                    onClick={() => { setIsExpanded(false); handleAccept(); }}
                                    style={{
                                        padding: '10px 24px',
                                        borderRadius: '8px',
                                        border: 'none',
                                        backgroundColor: '#10B981',
                                        color: '#fff',
                                        fontSize: '13px',
                                        fontWeight: '500',
                                        cursor: 'pointer',
                                    }}
                                >
                                    Accept Selection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Selection info */}
            {totalDuration > 0 && (
                <div style={{ marginTop: '8px', display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ fontSize: '11px', color: '#888' }}>
                        Selection: {formatTime(regionStart)} - {formatTime(regionStart + clipDuration)}
                    </span>
                    <span style={{ fontSize: '11px', color: '#666' }}>
                        Total: {formatTime(totalDuration)}
                    </span>
                </div>
            )}

            {/* Controls */}
            <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
                <button
                    onClick={handlePreview}
                    disabled={isLoading || totalDuration === 0}
                    style={{
                        flex: 1,
                        padding: '10px',
                        borderRadius: '8px',
                        border: '1px solid #3a3a3a',
                        backgroundColor: '#2a2a2a',
                        color: isPlaying ? '#10B981' : '#e0e0e0',
                        fontSize: '13px',
                        cursor: isLoading ? 'not-allowed' : 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px',
                    }}
                >
                    {isPlaying ? (
                        <>
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                <rect x="2" y="1" width="3" height="10" rx="1" />
                                <rect x="7" y="1" width="3" height="10" rx="1" />
                            </svg>
                            Stop
                        </>
                    ) : (
                        <>
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M2 1.5v9l8-4.5-8-4.5z" />
                            </svg>
                            Preview
                        </>
                    )}
                </button>
                <button
                    onClick={handleAccept}
                    disabled={isLoading || totalDuration === 0}
                    style={{
                        flex: 1,
                        padding: '10px',
                        borderRadius: '8px',
                        border: 'none',
                        backgroundColor: '#10B981',
                        color: '#fff',
                        fontSize: '13px',
                        fontWeight: '500',
                        cursor: isLoading ? 'not-allowed' : 'pointer',
                        opacity: isLoading ? 0.7 : 1,
                    }}
                >
                    {isLoading ? 'Processing...' : 'Accept'}
                </button>
            </div>

            {error && <div style={{ color: '#EF4444', fontSize: '12px', marginTop: '8px' }}>{error}</div>}
        </div>
    );
};

const fromApiType = (apiType) => {
    const match = apiType.match(/^(.+?)(?:-(short|medium|long))?$/);
    return match ? { base: match[1], duration: match[2] || 'short' } : { base: apiType, duration: null };
};

const GENRE_SUGGESTIONS = ['Pop', 'Rock', 'Metal', 'Jazz', 'R&B', 'Folk', 'Dance', 'Electronic', 'Hip Hop', 'Trap', 'Lo-fi', 'Synthwave', 'Punk', 'Blues', 'Country', 'Ambient', 'Soul', 'Funk', 'Reggae', 'Indie', 'EDM', 'Dubstep', 'House', 'Techno', 'Drum and Bass', 'Classical', 'Opera', 'Gospel', 'Ska', 'Grunge', 'Disco', 'New Wave', 'Shoegaze', 'Post-rock', 'Hardcore', 'Emo'];
const MOOD_SUGGESTIONS = ['happy', 'sad', 'energetic', 'romantic', 'angry', 'peaceful', 'melancholic', 'hopeful', 'aggressive', 'dreamy', 'nostalgic', 'euphoric', 'dark', 'chill', 'epic', 'intense', 'uplifting', 'mysterious', 'playful', 'haunting'];
const TIMBRE_SUGGESTIONS = ['bright', 'dark', 'soft', 'powerful', 'warm', 'clear', 'raspy', 'smooth', 'breathy', 'ethereal', 'gravelly', 'operatic', 'distorted', 'clean', 'raw', 'polished'];
const INSTRUMENT_SUGGESTIONS = ['piano', 'guitar', 'drums', 'bass', 'synth', 'strings', 'violin', 'cello', 'saxophone', 'trumpet', 'flute', 'organ', 'harp', 'percussion', 'choir', 'orchestra'];

const MultiSelectWithScroll = ({ suggestions, selected, onChange, placeholder }) => {
    const [input, setInput] = useState('');
    const scrollRef = useRef(null);

    const addTag = (tag) => {
        if (tag && !selected.includes(tag)) onChange([...selected, tag]);
        setInput('');
    };

    const removeTag = (tag) => onChange(selected.filter(t => t !== tag));

    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && input.trim()) { e.preventDefault(); addTag(input.trim()); }
        else if (e.key === 'Backspace' && !input && selected.length) removeTag(selected[selected.length - 1]);
    };

    return (
        <div>
            <div style={{
                backgroundColor: '#1e1e1e',
                border: '1px solid #3a3a3a',
                borderRadius: '10px',
                padding: '10px 12px',
                minHeight: '42px',
                display: 'flex',
                flexWrap: 'wrap',
                gap: '6px',
                alignItems: 'center',
            }}>
                {selected.map(tag => (
                    <span key={tag} style={{
                        backgroundColor: '#10B98130',
                        color: '#10B981',
                        padding: '4px 10px',
                        borderRadius: '6px',
                        fontSize: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        whiteSpace: 'nowrap',
                    }}>
                        {tag}
                        <span style={{ cursor: 'pointer', opacity: 0.7, fontSize: '14px' }} onClick={() => removeTag(tag)}></span>
                    </span>
                ))}
                <input
                    type="text"
                    value={input}
                    onChange={e => setInput(e.target.value)}
                    onKeyDown={handleKeyDown}
                    placeholder={selected.length === 0 ? placeholder : 'Type to add...'}
                    style={{
                        border: 'none',
                        background: 'transparent',
                        color: '#e0e0e0',
                        fontSize: '13px',
                        outline: 'none',
                        flex: 1,
                        minWidth: '80px',
                    }}
                />
            </div>
            {/* Horizontal scrolling tags */}
            <div
                ref={scrollRef}
                style={{
                    display: 'flex',
                    gap: '6px',
                    marginTop: '8px',
                    overflowX: 'auto',
                    paddingBottom: '4px',
                    scrollbarWidth: 'thin',
                    scrollbarColor: '#3a3a3a transparent',
                }}
            >
                {suggestions.filter(s => !selected.includes(s)).map(tag => (
                    <button
                        key={tag}
                        onClick={() => addTag(tag)}
                        style={{
                            padding: '5px 12px',
                            borderRadius: '16px',
                            border: '1px solid #3a3a3a',
                            backgroundColor: '#2a2a2a',
                            color: '#999',
                            fontSize: '11px',
                            cursor: 'pointer',
                            whiteSpace: 'nowrap',
                            flexShrink: 0,
                            transition: 'all 0.15s',
                        }}
                        onMouseOver={e => { e.target.style.borderColor = '#10B981'; e.target.style.color = '#10B981'; }}
                        onMouseOut={e => { e.target.style.borderColor = '#3a3a3a'; e.target.style.color = '#999'; }}
                    >
                        + {tag}
                    </button>
                ))}
            </div>
        </div>
    );
};

const Card = ({ children }) => (
    <div style={{
        backgroundColor: '#282828',
        borderRadius: '16px',
        padding: '20px',
    }}>
        {children}
    </div>
);

const CardTitle = ({ children }) => (
    <div style={{ fontSize: '13px', fontWeight: '500', color: '#888', marginBottom: '14px' }}>
        {children}
    </div>
);

const MultiSelect = ({ suggestions, selected, onChange, placeholder }) => {
    const [input, setInput] = useState('');
    const [showDropdown, setShowDropdown] = useState(false);

    const addTag = (tag) => {
        if (tag && !selected.includes(tag)) onChange([...selected, tag]);
        setInput('');
        setShowDropdown(false);
    };

    const removeTag = (tag) => onChange(selected.filter(t => t !== tag));

    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && input.trim()) { e.preventDefault(); addTag(input.trim()); }
        else if (e.key === 'Backspace' && !input && selected.length) removeTag(selected[selected.length - 1]);
    };

    const filtered = suggestions.filter(s => s.toLowerCase().includes(input.toLowerCase()) && !selected.includes(s));

    return (
        <div style={{ position: 'relative' }}>
            <div style={{
                backgroundColor: '#1e1e1e',
                border: '1px solid #3a3a3a',
                borderRadius: '10px',
                padding: '10px 12px',
                minHeight: '42px',
                display: 'flex',
                flexWrap: 'wrap',
                gap: '6px',
                alignItems: 'center',
                cursor: 'text',
            }} onClick={() => setShowDropdown(true)}>
                {selected.map(tag => (
                    <span key={tag} style={{
                        backgroundColor: '#3a3a3a',
                        color: '#e0e0e0',
                        padding: '4px 10px',
                        borderRadius: '6px',
                        fontSize: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                    }}>
                        {tag}
                        <span style={{ cursor: 'pointer', opacity: 0.6, fontSize: '14px' }} onClick={(e) => { e.stopPropagation(); removeTag(tag); }}>x</span>
                    </span>
                ))}
                <input
                    type="text"
                    value={input}
                    onChange={e => { setInput(e.target.value); setShowDropdown(true); }}
                    onFocus={() => setShowDropdown(true)}
                    onBlur={() => setTimeout(() => setShowDropdown(false), 200)}
                    onKeyDown={handleKeyDown}
                    placeholder={selected.length === 0 ? placeholder : ''}
                    style={{
                        border: 'none',
                        background: 'transparent',
                        color: '#e0e0e0',
                        fontSize: '13px',
                        outline: 'none',
                        flex: 1,
                        minWidth: '60px',
                    }}
                />
            </div>
            {showDropdown && filtered.length > 0 && (
                <div style={{
                    position: 'absolute',
                    top: '100%',
                    left: 0,
                    right: 0,
                    backgroundColor: '#2a2a2a',
                    border: '1px solid #3a3a3a',
                    borderRadius: '10px',
                    marginTop: '4px',
                    maxHeight: '180px',
                    overflowY: 'auto',
                    zIndex: 100,
                    boxShadow: '0 8px 24px rgba(0,0,0,0.4)',
                }}>
                    {filtered.slice(0, 8).map(s => (
                        <div
                            key={s}
                            onMouseDown={() => addTag(s)}
                            style={{ padding: '10px 14px', cursor: 'pointer', fontSize: '13px', transition: 'background 0.15s' }}
                            onMouseEnter={e => e.target.style.backgroundColor = '#3a3a3a'}
                            onMouseLeave={e => e.target.style.backgroundColor = 'transparent'}
                        >
                            {s}
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

const SectionCard = ({ section, onUpdate, onRemove }) => {
    const { base } = fromApiType(section.type);
    const cfg = SECTION_TYPES[base] || { name: base, color: '#888', hasLyrics: true };
    const lineCount = Math.max(3, (section.lyrics || '').split('\n').length + 1);

    return (
        <div style={{
            backgroundColor: '#282828',
            borderRadius: '12px',
            borderLeft: `4px solid ${cfg.color}`,
            overflow: 'hidden',
        }}>
            <div style={{
                padding: '14px 18px',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
            }}>
                <span style={{ fontSize: '15px', fontWeight: '500', color: cfg.color }}>{cfg.name}</span>
                <button
                    onClick={onRemove}
                    style={{
                        background: 'transparent',
                        border: 'none',
                        color: '#555',
                        cursor: 'pointer',
                        fontSize: '20px',
                        padding: '4px 8px',
                        lineHeight: 1,
                        transition: 'color 0.15s',
                    }}
                    onMouseEnter={e => e.target.style.color = '#888'}
                    onMouseLeave={e => e.target.style.color = '#555'}
                >x</button>
            </div>
            {cfg.hasLyrics && (
                <div style={{ padding: '0 18px 16px 18px' }}>
                    <textarea
                        value={section.lyrics || ''}
                        onChange={e => onUpdate({ lyrics: e.target.value })}
                        placeholder="Enter lyrics..."
                        rows={lineCount}
                        style={{
                            width: '100%',
                            backgroundColor: 'transparent',
                            border: 'none',
                            color: '#999',
                            fontSize: '14px',
                            lineHeight: '1.8',
                            resize: 'none',
                            outline: 'none',
                        }}
                    />
                </div>
            )}
        </div>
    );
};

const LibraryItem = ({ item, isQueued, isGenerating, queuePosition, onRemoveFromQueue, onStop, onDelete, status, elapsedTime, estimatedTime }) => {
    const [expanded, setExpanded] = useState(false);
    const meta = (isQueued || isGenerating) ? item : (item.metadata || {});

    const formatDate = (dateStr) => {
        if (!dateStr) return 'Unknown';
        try {
            return new Date(dateStr).toLocaleString();
        } catch { return dateStr; }
    };

    const formatDuration = (start, end) => {
        if (!start || !end) return '';
        try {
            const ms = new Date(end) - new Date(start);
            const mins = Math.floor(ms / 60000);
            const secs = Math.floor((ms % 60000) / 1000);
            return `${mins}m ${secs}s`;
        } catch { return ''; }
    };

    return (
        <div style={{
            backgroundColor: '#282828',
            borderRadius: '12px',
            padding: '16px',
            display: 'flex',
            flexDirection: 'column',
            gap: '12px',
        }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <div style={{ flex: 1 }}>
                    <div style={{ fontSize: '15px', fontWeight: '500', color: '#e0e0e0' }}>{item.title || 'Untitled'}</div>
                    <div style={{ fontSize: '12px', color: '#888', marginTop: '4px' }}>
                        {isGenerating ? (status || 'Generating...') : (isQueued ? `Queue position: #${queuePosition}` : formatDate(item.created_at))}
                        {((isQueued || isGenerating) ? item.model : meta.model) && <span style={{ marginLeft: '12px', color: '#666' }}>{(isQueued || isGenerating) ? item.model : meta.model}</span>}
                    </div>
                    {/* Style tags */}
                    <div style={{ display: 'flex', gap: '6px', marginTop: '8px', flexWrap: 'wrap' }}>
                        {meta.gender && <span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '11px', backgroundColor: '#3B82F620', color: '#3B82F6' }}>{meta.gender}</span>}
                        {meta.genre && <span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '11px', backgroundColor: '#8B5CF620', color: '#8B5CF6' }}>{meta.genre}</span>}
                        {meta.emotion && <span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '11px', backgroundColor: '#F59E0B20', color: '#F59E0B' }}>{meta.emotion}</span>}
                        {meta.bpm && <span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '11px', backgroundColor: '#10B98120', color: '#10B981' }}>{meta.bpm} BPM</span>}
                    </div>
                </div>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    {!isQueued && !isGenerating && item.status === 'completed' && item.output_files?.length > 0 && (<>{['FLAC', 'MP3'].map((fmt) => (<button key={fmt} onClick={() => { const a = document.createElement('a'); a.href = `/api/audio/${item.id}/0?format=${fmt.toLowerCase()}`; a.download = `${item.title || 'song'}.${fmt.toLowerCase()}`; a.click(); }} style={{ background: 'none', border: '1px solid #10B981', borderRadius: '6px', padding: '4px 10px', color: '#10B981', cursor: 'pointer', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '4px' }}><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>{fmt}</button>))}</>)}
                    {isGenerating && (
                        <button
                            onClick={onStop}
                            style={{
                                background: 'none',
                                border: '1px solid #EF4444',
                                borderRadius: '6px',
                                padding: '4px 10px',
                                color: '#EF4444',
                                cursor: 'pointer',
                                fontSize: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px',
                            }}
                        >
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="6" width="12" height="12" rx="1"/>
                            </svg>
                            Stop
                        </button>
                    )}
                    {isQueued && (
                        <button
                            onClick={onRemoveFromQueue}
                            style={{
                                background: 'none',
                                border: '1px solid #EF4444',
                                borderRadius: '6px',
                                padding: '4px 10px',
                                color: '#EF4444',
                                cursor: 'pointer',
                                fontSize: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px',
                            }}
                        >
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                            Remove
                        </button>
                    )}
                    <button
                        onClick={() => setExpanded(!expanded)}
                        style={{
                            background: 'none',
                            border: '1px solid #444',
                            borderRadius: '6px',
                            padding: '4px 10px',
                            color: '#888',
                            cursor: 'pointer',
                            fontSize: '12px',
                        }}
                    >
                        {expanded ? 'Hide' : 'Details'}
                    </button>
                    {!isQueued && !isGenerating && (item.status === 'completed' || item.status === 'failed' || item.status === 'stopped') && (
                        <button
                            onClick={onDelete}
                            style={{
                                background: 'none',
                                border: '1px solid #666',
                                borderRadius: '6px',
                                padding: '4px 10px',
                                color: '#666',
                                cursor: 'pointer',
                                fontSize: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px',
                            }}
                            title="Delete generation"
                        >
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    )}
                    <span style={{
                        padding: '4px 10px',
                        borderRadius: '6px',
                        fontSize: '11px',
                        fontWeight: '500',
                        backgroundColor: isGenerating ? '#F59E0B20' : (isQueued ? '#6366F120' : (item.status === 'completed' ? '#10B98120' : item.status === 'failed' ? '#EF444420' : '#F59E0B20')),
                        color: isGenerating ? '#F59E0B' : (isQueued ? '#6366F1' : (item.status === 'completed' ? '#10B981' : item.status === 'failed' ? '#EF4444' : '#F59E0B')),
                    }}>
                        {isGenerating ? 'generating' : (isQueued ? 'queued' : item.status)}
                    </span>
                </div>
            </div>

            {/* Audio players */}
            {!isQueued && !isGenerating && item.status === 'completed' && item.output_files?.map((f, i) => (
                <DarkAudioPlayer key={i} src={`/api/audio/${item.id}/${i}`} />
            ))}

            {/* Expanded details */}
            {expanded && (
                <div style={{
                    backgroundColor: '#1a1a1a',
                    borderRadius: '8px',
                    padding: '12px',
                    fontSize: '12px',
                    display: 'grid',
                    gridTemplateColumns: 'repeat(2, 1fr)',
                    gap: '8px 16px',
                }}>
                    <div><span style={{ color: '#666' }}>Model:</span> <span style={{ color: '#aaa' }}>{meta.model || 'unknown'}</span></div>
                    <div><span style={{ color: '#666' }}>Output Mode:</span> <span style={{ color: '#aaa' }}>{meta.output_mode || 'mixed'}</span></div>
                    <div><span style={{ color: '#666' }}>Voice:</span> <span style={{ color: '#aaa' }}>{meta.gender || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>BPM:</span> <span style={{ color: '#aaa' }}>{meta.bpm || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>Genre:</span> <span style={{ color: '#aaa' }}>{meta.genre || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>Mood:</span> <span style={{ color: '#aaa' }}>{meta.emotion || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>Timbre:</span> <span style={{ color: '#aaa' }}>{meta.timbre || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>Instruments:</span> <span style={{ color: '#aaa' }}>{meta.instruments || '-'}</span></div>
                    {meta.custom_style && <div style={{ gridColumn: '1 / -1' }}><span style={{ color: '#666' }}>Custom Style:</span> <span style={{ color: '#aaa' }}>{meta.custom_style}</span></div>}
                    {!isQueued && !isGenerating && <div style={{ gridColumn: '1 / -1' }}><span style={{ color: '#666' }}>Created:</span> <span style={{ color: '#aaa' }}>{formatDate(meta.created_at)}</span></div>}
                    {!isQueued && !isGenerating && meta.completed_at && (
                        <div style={{ gridColumn: '1 / -1' }}><span style={{ color: '#666' }}>Completed:</span> <span style={{ color: '#aaa' }}>{formatDate(meta.completed_at)} ({formatDuration(meta.created_at, meta.completed_at)})</span></div>
                    )}
                    {meta.description && (
                        <div style={{ gridColumn: '1 / -1', marginTop: '8px' }}>
                            <div style={{ color: '#666', marginBottom: '4px' }}>Description sent to model:</div>
                            <div style={{ color: '#10B981', fontFamily: 'monospace', fontSize: '11px', padding: '8px', backgroundColor: '#0a0a0a', borderRadius: '4px' }}>{meta.description}</div>
                        </div>
                    )}
                    {meta.sections && meta.sections.length > 0 && (
                        <div style={{ gridColumn: '1 / -1', marginTop: '8px' }}>
                            <div style={{ color: '#666', marginBottom: '4px' }}>Sections ({meta.sections.length}):</div>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                {meta.sections.map((s, i) => (
                                    <div key={i} style={{ padding: '8px 10px', backgroundColor: '#0a0a0a', borderRadius: '4px', borderLeft: `3px solid ${SECTION_TYPES[s.type]?.color || '#666'}` }}>
                                        <div style={{ color: SECTION_TYPES[s.type]?.color || '#888', fontWeight: '500', marginBottom: s.lyrics ? '6px' : '0' }}>[{s.type}]</div>
                                        {s.lyrics && <div style={{ color: '#999', whiteSpace: 'pre-wrap', lineHeight: '1.5', fontSize: '11px' }}>{s.lyrics}</div>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    {(meta.reference_audio || meta.reference_audio_id) && (
                        <div style={{ gridColumn: '1 / -1' }}>
                            <div style={{ color: '#666', marginBottom: '8px' }}>Reference Audio (style cloning):</div>
                            <DarkAudioPlayer src={`/api/reference/${meta.reference_audio_id || meta.reference_audio?.replace(/\\/g, '/').split('/').pop()?.split('_')[0]}`} />
                        </div>
                    )}
                </div>
            )}
        </div>
    );
};

const App = () => {
    const [activeTab, setActiveTab] = useState('create');
    const [sections, setSections] = useState([
        { id: '1', type: 'intro-short', lyrics: '' },
        { id: '2', type: 'verse', lyrics: '' },
        { id: '3', type: 'chorus', lyrics: '' },
        { id: '4', type: 'verse', lyrics: '' },
        { id: '5', type: 'outro-short', lyrics: '' },
    ]);
    const [title, setTitle] = useState('My New Song');
    const [gender, setGender] = useState('female');
    const [genres, setGenres] = useState([]);
    const [moods, setMoods] = useState([]);
    const [timbres, setTimbres] = useState([]);
    const [instruments, setInstruments] = useState([]);
    const [customStyle, setCustomStyle] = useState('');
    const [bpm, setBpm] = useState(120);
    const [outputMode, setOutputMode] = useState('mixed');
    const [memoryMode, setMemoryMode] = useState('auto');
    // Advanced generation parameters
    const [cfgCoef, setCfgCoef] = useState(1.5);
    const [temperature, setTemperature] = useState(0.8);
    const [topK, setTopK] = useState(50);
    const [topP, setTopP] = useState(0.0);
    const [extendStride, setExtendStride] = useState(5);
    const [showAdvanced, setShowAdvanced] = useState(false);
    const [models, setModels] = useState([]);
    const [selectedModel, setSelectedModel] = useState('songgeneration_base');
    const [generating, setGenerating] = useState(false);
    const [progress, setProgress] = useState(0);
    const [status, setStatus] = useState('');
    const [error, setError] = useState(null);
    const [audio, setAudio] = useState(null);
    const [showAddMenu, setShowAddMenu] = useState(false);
    const [addMenuPos, setAddMenuPos] = useState({ x: 0, y: 0 });
    const [library, setLibrary] = useState([]);
    const [refFile, setRefFile] = useState(null);
    const [refId, setRefId] = useState(null);
    const [useReference, setUseReference] = useState(false);
    const [refFileLoaded, setRefFileLoaded] = useState(false);  // Track if a reference file is loaded (even before accept)
    const [genStartTime, setGenStartTime] = useState(null);
    const [estimatedTime, setEstimatedTime] = useState(null);
    const [elapsedTime, setElapsedTime] = useState(0);
    const [gpuInfo, setGpuInfo] = useState(null);
    // Queue system
    const [queue, setQueue] = useState([]);
    const [currentGenId, setCurrentGenId] = useState(null);
    const [currentGenPayload, setCurrentGenPayload] = useState(null);
    const pollRef = useRef(null);
    const addBtnRef = useRef(null);
    const timerRef = useRef(null);

    useEffect(() => { loadModels(); loadLibrary(); loadGpuInfo(); }, []);
    useEffect(() => () => {
        pollRef.current && clearInterval(pollRef.current);
        timerRef.current && clearInterval(timerRef.current);
    }, []);

    // Auto-set output mode based on lyrics presence
    useEffect(() => {
        const hasLyrics = sections.some(s => s.lyrics && s.lyrics.trim().length > 0);
        if (hasLyrics && outputMode === 'bgm') {
            setOutputMode('mixed');
        } else if (!hasLyrics && outputMode === 'mixed') {
            setOutputMode('bgm');
        }
    }, [sections]);

    // Auto-select best model based on available VRAM
    useEffect(() => {
        if (!gpuInfo?.gpu?.total_gb || models.length === 0) return;
        const vram = gpuInfo.gpu.total_gb;
        // Model VRAM requirements: large=22GB, base_full=12GB, base/base_new=10GB
        let bestModel = 'songgeneration_base';
        if (vram >= 22 && models.some(m => m.id === 'songgeneration_large')) {
            bestModel = 'songgeneration_large';
        } else if (vram >= 12 && models.some(m => m.id === 'songgeneration_base_full')) {
            bestModel = 'songgeneration_base_full';
        } else if (models.some(m => m.id === 'songgeneration_base_new')) {
            bestModel = 'songgeneration_base_new';
        }
        setSelectedModel(bestModel);
    }, [gpuInfo, models]);

    // Time estimation based on model and lyrics
    const estimateGenerationTime = useCallback((model, sectionsList) => {
        // Base times in seconds for each model (approximate)
        const modelBaseTimes = {
            'songgeneration_base': 180,       // ~3 minutes
            'songgeneration_base_new': 200,   // ~3.5 minutes
            'songgeneration_base_full': 300,  // ~5 minutes (longer output)
            'songgeneration_large': 420,      // ~7 minutes (best quality, longer)
        };

        // Get base time for model
        let baseTime = modelBaseTimes[model] || 240; // default 4 minutes

        // Calculate total lyrics length
        const totalLyrics = sectionsList.reduce((acc, s) => {
            return acc + (s.lyrics || '').length;
        }, 0);

        // Calculate number of sections
        const numSections = sectionsList.length;

        // Adjust time based on lyrics length (more lyrics = more time)
        // ~30 seconds per 500 characters
        const lyricsTimeAdjust = Math.floor(totalLyrics / 500) * 30;

        // Adjust for number of sections (~10 seconds per section beyond 3)
        const sectionsAdjust = Math.max(0, numSections - 3) * 10;

        // Count instrumental/duration sections (they add time)
        const durationSections = sectionsList.filter(s =>
            s.type.includes('intro') || s.type.includes('outro') || s.type.includes('inst')
        ).length;
        const durationAdjust = durationSections * 15;

        return baseTime + lyricsTimeAdjust + sectionsAdjust + durationAdjust;
    }, []);

    const formatTimeRemaining = (seconds) => {
        if (seconds <= 0) return 'finishing...';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        if (mins > 0) {
            return `~${mins}m ${secs}s remaining`;
        }
        return `~${secs}s remaining`;
    };

    // Close popup when clicking outside
    useEffect(() => {
        const handleClick = (e) => {
            if (showAddMenu && addBtnRef.current && !addBtnRef.current.contains(e.target)) {
                setShowAddMenu(false);
            }
        };
        document.addEventListener('click', handleClick);
        return () => document.removeEventListener('click', handleClick);
    }, [showAddMenu]);

    const loadModels = async () => {
        try {
            const r = await fetch('/api/models');
            if (r.ok) {
                const d = await r.json();
                setModels(d.models || []);
                if (d.default) setSelectedModel(d.default);
            }
        } catch (e) { console.error(e); }
    };

    const loadGpuInfo = async () => {
        try {
            const r = await fetch('/api/gpu');
            if (r.ok) {
                const d = await r.json();
                setGpuInfo(d);
            }
        } catch (e) { console.error(e); }
    };

    const loadLibrary = async () => {
        try {
            const r = await fetch('/api/generations');
            if (r.ok) {
                const data = await r.json();
                setLibrary(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
            }
        } catch (e) { console.error(e); }
    };

    const deleteGeneration = async (genId) => {
        try {
            const r = await fetch(`/api/generation/${genId}`, { method: 'DELETE' });
            if (r.ok) {
                setLibrary(prev => prev.filter(item => item.id !== genId));
            }
        } catch (e) { console.error(e); }
    };

    const poll = useCallback(async (id) => {
        try {
            const r = await fetch(`/api/generation/${id}`);
            if (!r.ok) return;
            const d = await r.json();
            setProgress(d.progress);
            setStatus(d.message);
            if (d.status === 'completed') {
                clearInterval(pollRef.current);
                clearInterval(timerRef.current);
                setCurrentGenId(null);
                setCurrentGenPayload(null);
                setAudio({ id, files: d.output_files });
                setGenStartTime(null);
                setEstimatedTime(null);
                setElapsedTime(0);
                loadLibrary();
                // Process next in queue
                setQueue(prev => {
                    if (prev.length > 0) {
                        const [next, ...rest] = prev;
                        setTimeout(() => startGeneration(next), 100);
                        return rest;
                    }
                    setGenerating(false);
                    return prev;
                });
            } else if (d.status === 'failed' || d.status === 'stopped') {
                clearInterval(pollRef.current);
                clearInterval(timerRef.current);
                setCurrentGenId(null);
                setCurrentGenPayload(null);
                if (d.status === 'failed') setError(d.message);
                setGenStartTime(null);
                setEstimatedTime(null);
                setElapsedTime(0);
                // Process next in queue
                setQueue(prev => {
                    if (prev.length > 0) {
                        const [next, ...rest] = prev;
                        setTimeout(() => startGeneration(next), 100);
                        return rest;
                    }
                    setGenerating(false);
                    return prev;
                });
            }
        } catch (e) { console.error(e); }
    }, []);

    // Create payload from current settings
    const createPayload = () => ({
        title,
        sections: sections.map(s => ({ type: s.type, lyrics: s.lyrics || null })),
        gender,
        genre: genres.join(', '),
        emotion: moods.join(', '),
        timbre: timbres.join(', '),
        instruments: instruments.join(', '),
        custom_style: customStyle,
        bpm,
        output_mode: outputMode,
        model: selectedModel,
        memory_mode: memoryMode,
        reference_audio_id: useReference ? refId : null,
        cfg_coef: cfgCoef,
        temperature: temperature,
        top_k: topK,
        top_p: topP,
        extend_stride: extendStride,
    });

    // Start generation from a payload
    const startGeneration = async (payload) => {
        setProgress(0);
        setStatus('Starting...');
        setError(null);
        setAudio(null);
        setCurrentGenPayload(payload);

        // Set up time estimation
        const estimated = estimateGenerationTime(payload.model, payload.sections);
        setEstimatedTime(estimated);
        setGenStartTime(Date.now());
        setElapsedTime(0);

        // Start elapsed time counter
        timerRef.current = setInterval(() => {
            setElapsedTime(prev => prev + 1);
        }, 1000);

        try {
            const r = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!r.ok) throw new Error(await r.text());
            const { generation_id } = await r.json();
            setCurrentGenId(generation_id);
            pollRef.current = setInterval(() => poll(generation_id), 2000);
        } catch (e) {
            setGenerating(false);
            setCurrentGenId(null);
            setCurrentGenPayload(null);
            setError(e.message);
            // Try next in queue
            setQueue(prev => {
                if (prev.length > 0) {
                    const [next, ...rest] = prev;
                    setTimeout(() => startGeneration(next), 100);
                    return rest;
                }
                return prev;
            });
        }
    };

    // Main generate function - starts immediately or adds to queue
    const generate = async () => {
        const payload = createPayload();

        if (generating) {
            // Already generating, add to queue
            setQueue(prev => [...prev, payload]);
        } else {
            // Start immediately
            setGenerating(true);
            startGeneration(payload);
        }
    };

    // Stop current generation
    const stopGeneration = async () => {
        if (!currentGenId) return;
        try {
            await fetch(`/api/stop/${currentGenId}`, { method: 'POST' });
            setStatus('Stopping...');
        } catch (e) {
            console.error('Failed to stop:', e);
        }
    };

    // Clear the queue
    const clearQueue = () => {
        setQueue([]);
    };

    // Remove specific item from queue by index
    const removeFromQueue = (index) => {
        setQueue(prev => prev.filter((_, i) => i !== index));
    };

    const toggleAddMenu = (e) => {
        e.stopPropagation();
        if (!showAddMenu) {
            const rect = e.currentTarget.getBoundingClientRect();
            const popupHeight = 280; // Approximate height of popup
            const spaceBelow = window.innerHeight - rect.bottom;
            const openUpward = spaceBelow < popupHeight;

            setAddMenuPos({
                x: rect.left,
                y: openUpward ? rect.top : rect.bottom + 8,
                openUpward
            });
        }
        setShowAddMenu(!showAddMenu);
    };

    const addSection = (base) => {
        const cfg = SECTION_TYPES[base];
        const type = cfg?.hasDuration ? `${base}-short` : base;
        setSections([...sections, { id: Date.now().toString(), type, lyrics: '' }]);
        setShowAddMenu(false);
    };

    const removeSection = (id) => setSections(sections.filter(s => s.id !== id));
    const updateSection = (id, updates) => setSections(sections.map(s => s.id === id ? { ...s, ...updates } : s));

    const handleDragStart = (e, id) => { e.dataTransfer.setData('text/plain', id); e.dataTransfer.effectAllowed = 'move'; };
    const handleDragOver = (e) => { e.preventDefault(); };
    const handleDrop = (e, targetId) => {
        e.preventDefault();
        const dragId = e.dataTransfer.getData('text/plain');
        if (dragId === targetId) return;
        const dragIndex = sections.findIndex(s => s.id === dragId);
        const targetIndex = sections.findIndex(s => s.id === targetId);
        const newSections = [...sections];
        const [removed] = newSections.splice(dragIndex, 1);
        newSections.splice(targetIndex, 0, removed);
        setSections(newSections);
    };

    const btnStyle = (isActive, activeColor = '#10B981') => ({
        flex: 1,
        padding: '10px 16px',
        borderRadius: '10px',
        border: 'none',
        fontSize: '13px',
        fontWeight: '500',
        cursor: 'pointer',
        transition: 'all 0.15s',
        backgroundColor: isActive ? activeColor : '#1e1e1e',
        color: isActive ? '#fff' : '#777',
    });

    // Calculate footer height for padding
    const footerHeight = 70;

    return (
        <div style={{
            height: '100vh',
            backgroundColor: '#1e1e1e',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden',
        }}>
            {/* Header */}
            <header style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                padding: '20px 24px',
                maxWidth: '1400px',
                margin: '0 auto',
                width: '100%',
                boxSizing: 'border-box',
                flexShrink: 0,
                position: 'relative',
            }}>
                <div style={{ position: 'absolute', left: '24px', display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <img src="/static/Logo_1.png" alt="SongGeneration" style={{ height: '36px' }} />
                    <div>
                        <div style={{ fontSize: '18px', fontWeight: '600', color: '#e0e0e0' }}>SongGeneration Studio</div>
                        <div style={{ fontSize: '11px', color: '#666' }}>by Tencent AI Lab</div>
                    </div>
                </div>

                {/* Tabs - Centered */}
                <div style={{ display: 'flex', gap: '4px', backgroundColor: '#282828', padding: '4px', borderRadius: '12px' }}>
                    <button
                        onClick={() => setActiveTab('create')}
                        style={{
                            padding: '10px 24px',
                            borderRadius: '10px',
                            border: 'none',
                            fontSize: '14px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            backgroundColor: activeTab === 'create' ? '#10B981' : 'transparent',
                            color: activeTab === 'create' ? '#fff' : '#888',
                            transition: 'all 0.15s',
                        }}
                    >
                        Create
                    </button>
                    <button
                        onClick={() => { setActiveTab('library'); loadLibrary(); }}
                        style={{
                            padding: '10px 24px',
                            borderRadius: '10px',
                            border: 'none',
                            fontSize: '14px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            backgroundColor: activeTab === 'library' ? '#10B981' : 'transparent',
                            color: activeTab === 'library' ? '#fff' : '#888',
                            transition: 'all 0.15s',
                        }}
                    >
                        Library
                    </button>
                </div>

                <div style={{ position: 'absolute', right: '24px', fontSize: '11px', color: '#888', textAlign: 'right' }}>
                    <div>UI by <a href="https://bazed.org" target="_blank" style={{ color: '#10B981', textDecoration: 'none' }}>Bazed.org</a></div>
                </div>
            </header>

            {/* Scrollable Content Area */}
            <div style={{
                flex: 1,
                overflowY: 'auto',
                overflowX: 'hidden',
            }}>
                {/* Create View */}
                <div style={{ display: activeTab === 'create' ? 'block' : 'none' }}>
                    <div style={{ display: 'flex', gap: '24px', maxWidth: '1400px', margin: '0 auto', padding: '0 24px 24px 24px' }}>
                    {/* Sidebar */}
                    <aside style={{ width: '320px', flexShrink: 0, display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        {/* Model */}
                        <Card>
                            <CardTitle>Model</CardTitle>
                            <div style={{ position: 'relative' }}>
                                <select
                                    className="custom-select"
                                    value={selectedModel}
                                    onChange={e => setSelectedModel(e.target.value)}
                                    style={{
                                        width: '100%',
                                        backgroundColor: '#1e1e1e',
                                        border: '1px solid #3a3a3a',
                                        borderRadius: '10px',
                                        padding: '12px 14px',
                                        paddingRight: '40px',
                                        color: '#e0e0e0',
                                        fontSize: '13px',
                                        cursor: 'pointer',
                                        outline: 'none',
                                    }}
                                >
                                    {models.map(m => <option key={m.id} value={m.id}>{m.name} - {m.description}</option>)}
                                    {models.length === 0 && <option value="">Loading...</option>}
                                </select>
                                {/* Chevron icon */}
                                <svg
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="#888"
                                    strokeWidth="2"
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    style={{
                                        position: 'absolute',
                                        right: '14px',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                    }}
                                >
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                        </Card>

                        {/* Memory Mode */}
                        <Card>
                            <CardTitle>Memory Mode</CardTitle>
                            {gpuInfo && gpuInfo.gpu && (
                                <div style={{ fontSize: '11px', color: '#888', marginBottom: '10px' }}>
                                    {gpuInfo.gpu.name}  {gpuInfo.gpu.free_gb}GB free / {gpuInfo.gpu.total_gb}GB total
                                </div>
                            )}
                            {(() => {
                                // Wait for GPU info to load before showing anything
                                if (!gpuInfo || !gpuInfo.gpu) {
                                    return (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            {['auto', 'low', 'high'].map(mode => (
                                                <button key={mode} style={{ ...btnStyle(mode === 'auto'), opacity: 0.5 }} disabled>
                                                    {mode.charAt(0).toUpperCase() + mode.slice(1)}
                                                </button>
                                            ))}
                                        </div>
                                    );
                                }

                                const freeVram = gpuInfo.gpu.free_gb || 0;
                                const hasRef = refFileLoaded || !!refId;  // Check if file is loaded OR already accepted

                                // VRAM requirements per model: { low: X, high: Y, highWithRef: Z }
                                const modelVramReqs = {
                                    'songgeneration_base': { low: 10, high: 10, highWithRef: 16 },
                                    'songgeneration_base_new': { low: 10, high: 10, highWithRef: 16 },
                                    'songgeneration_base_full': { low: 10, high: 12, highWithRef: 18 },
                                    'songgeneration_large': { low: 10, high: 22, highWithRef: 28 },
                                };

                                const reqs = modelVramReqs[selectedModel] || modelVramReqs['songgeneration_base'];
                                const highVramNeeded = hasRef ? reqs.highWithRef : reqs.high;
                                const canRunLow = freeVram >= reqs.low;
                                const canRunHigh = freeVram >= highVramNeeded;

                                // Can't run at all - not enough VRAM
                                if (!canRunLow) {
                                    return (
                                        <div style={{
                                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                            border: '1px solid rgba(239, 68, 68, 0.3)',
                                            borderRadius: '8px',
                                            padding: '12px',
                                            textAlign: 'center',
                                        }}>
                                            <div style={{ color: '#EF4444', fontSize: '13px', fontWeight: '500', marginBottom: '4px' }}>
                                                Insufficient VRAM
                                            </div>
                                            <div style={{ color: '#888', fontSize: '11px' }}>
                                                This model requires at least {reqs.low}GB VRAM ({freeVram.toFixed(1)}GB available)
                                            </div>
                                        </div>
                                    );
                                }

                                return (
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        {['auto', 'low', 'high'].map(mode => {
                                            const isHighMode = mode === 'high';
                                            const isDisabled = isHighMode && !canRunHigh;

                                            let tooltip = '';
                                            if (mode === 'auto') {
                                                tooltip = `Auto-selects based on available VRAM`;
                                            } else if (mode === 'low') {
                                                tooltip = `Optimized for lower VRAM (${reqs.low}GB min)`;
                                            } else if (isDisabled) {
                                                tooltip = `Requires ${highVramNeeded}GB VRAM (${freeVram.toFixed(1)}GB available)`;
                                            } else {
                                                tooltip = `Full quality mode (${highVramNeeded}GB${hasRef ? ' with reference' : ''})`;
                                            }

                                            return (
                                                <button
                                                    key={mode}
                                                    onClick={() => !isDisabled && setMemoryMode(mode)}
                                                    disabled={isDisabled}
                                                    title={tooltip}
                                                    style={{
                                                        ...btnStyle(memoryMode === mode),
                                                        opacity: isDisabled ? 0.4 : 1,
                                                        cursor: isDisabled ? 'not-allowed' : 'pointer',
                                                    }}
                                                >
                                                    {mode.charAt(0).toUpperCase() + mode.slice(1)}
                                                </button>
                                            );
                                        })}
                                    </div>
                                );
                            })()}
                        </Card>

                        {/* Song Settings */}
                        <Card>
                            <CardTitle>Song Settings</CardTitle>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Voice</div>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <button onClick={() => setGender('female')} style={btnStyle(gender === 'female', '#3B82F6')}>Female</button>
                                    <button onClick={() => setGender('male')} style={btnStyle(gender === 'male', '#3B82F6')}>Male</button>
                                </div>
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Genre</div>
                                <MultiSelectWithScroll suggestions={GENRE_SUGGESTIONS} selected={genres} onChange={setGenres} placeholder="Select or type genre..." />
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Mood</div>
                                <MultiSelectWithScroll suggestions={MOOD_SUGGESTIONS} selected={moods} onChange={setMoods} placeholder="Select or type mood..." />
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Timbre</div>
                                <MultiSelectWithScroll suggestions={TIMBRE_SUGGESTIONS} selected={timbres} onChange={setTimbres} placeholder="Select or type timbre..." />
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Instruments</div>
                                <MultiSelectWithScroll suggestions={INSTRUMENT_SUGGESTIONS} selected={instruments} onChange={setInstruments} placeholder="Select or type instruments..." />
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Custom Style (Advanced)</div>
                                <input
                                    type="text"
                                    value={customStyle}
                                    onChange={e => setCustomStyle(e.target.value)}
                                    placeholder="e.g. dubstep wobble, 808 bass, vinyl crackle..."
                                    style={{
                                        width: '100%',
                                        backgroundColor: '#1e1e1e',
                                        border: '1px solid #3a3a3a',
                                        borderRadius: '10px',
                                        padding: '12px 14px',
                                        color: '#e0e0e0',
                                        fontSize: '13px',
                                        outline: 'none',
                                        boxSizing: 'border-box',
                                    }}
                                />
                                <div style={{ fontSize: '10px', color: '#555', marginTop: '4px' }}>Add any custom style descriptors not in the presets above</div>
                            </div>

                            <div>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px', display: 'flex', justifyContent: 'space-between' }}>
                                    <span>BPM</span><span style={{ color: '#10B981', fontWeight: '500' }}>{bpm}</span>
                                </div>
                                <input type="range" min="60" max="180" value={bpm} onChange={e => setBpm(+e.target.value)} />
                            </div>
                        </Card>

                        {/* Reference Audio with Waveform Trimmer */}
                        <Card>
                            <CardTitle>Reference Audio</CardTitle>
                            <AudioTrimmer
                                onAccept={(data) => {
                                    setRefId(data.id);
                                    setRefFile({ name: data.fileName });
                                    setUseReference(true);
                                }}
                                onClear={() => {
                                    setRefId(null);
                                    setRefFile(null);
                                    setUseReference(false);
                                    setRefFileLoaded(false);
                                }}
                                onFileLoad={(loaded) => setRefFileLoaded(loaded)}
                            />
                        </Card>

                        {/* Output */}
                        <Card>
                            <CardTitle>Output</CardTitle>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                                {['mixed', 'vocal', 'bgm', 'separate'].map(mode => (
                                    <button
                                        key={mode}
                                        onClick={() => setOutputMode(mode)}
                                        style={{
                                            padding: '12px',
                                            borderRadius: '10px',
                                            border: outputMode === mode ? '1px solid #10B981' : '1px solid #3a3a3a',
                                            backgroundColor: outputMode === mode ? '#10B98115' : '#1e1e1e',
                                            color: outputMode === mode ? '#10B981' : '#777',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                        }}
                                    >
                                        {mode === 'mixed' ? 'Full Song' : mode === 'vocal' ? 'Vocals' : mode === 'bgm' ? 'Instrumental' : 'Separate'}
                                    </button>
                                ))}
                            </div>
                        </Card>

{/* Advanced Settings */}                        <Card>                            <div onClick={() => setShowAdvanced(!showAdvanced)} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer', marginBottom: showAdvanced ? '14px' : '0' }}>                                <span style={{ fontSize: '13px', fontWeight: '500', color: '#888' }}>Advanced Settings</span>                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#888" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ transition: 'transform 0.2s', transform: showAdvanced ? 'rotate(180deg)' : 'rotate(0deg)' }}><path d="M6 9l6 6 6-6"/></svg>                            </div>                            {showAdvanced && (                                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>                                    <div>                                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px', display: 'flex', justifyContent: 'space-between' }}><span>Style Strength</span><span style={{ color: '#10B981', fontWeight: '500' }}>{cfgCoef.toFixed(1)}</span></div>                                        <input type="range" min="0.1" max="3.0" step="0.1" value={cfgCoef} onChange={e => setCfgCoef(+e.target.value)} />                                        <div style={{ fontSize: '10px', color: '#555', marginTop: '4px' }}>Higher = follows your style more strictly</div>                                    </div>                                    <div>                                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px', display: 'flex', justifyContent: 'space-between' }}><span>Creativity</span><span style={{ color: '#10B981', fontWeight: '500' }}>{temperature.toFixed(1)}</span></div>                                        <input type="range" min="0.1" max="2.0" step="0.1" value={temperature} onChange={e => setTemperature(+e.target.value)} />                                        <div style={{ fontSize: '10px', color: '#555', marginTop: '4px' }}>Higher = more experimental</div>                                    </div>                                    <div>                                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px', display: 'flex', justifyContent: 'space-between' }}><span>Variety</span><span style={{ color: '#10B981', fontWeight: '500' }}>{topK}</span></div>                                        <input type="range" min="1" max="250" step="1" value={topK} onChange={e => setTopK(+e.target.value)} />                                        <div style={{ fontSize: '10px', color: '#555', marginTop: '4px' }}>Musical choices per step</div>                                    </div>                                    <div>                                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px', display: 'flex', justifyContent: 'space-between' }}><span>Focus (Top-P)</span><span style={{ color: '#10B981', fontWeight: '500' }}>{topP.toFixed(1)}</span></div>                                        <input type="range" min="0" max="1.0" step="0.1" value={topP} onChange={e => setTopP(+e.target.value)} />                                        <div style={{ fontSize: '10px', color: '#555', marginTop: '4px' }}>0=off, else limits choices by probability</div>                                    </div>                                    <div>                                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px', display: 'flex', justifyContent: 'space-between' }}><span>Extend Stride</span><span style={{ color: '#10B981', fontWeight: '500' }}>{extendStride}</span></div>                                        <input type="range" min="1" max="15" step="1" value={extendStride} onChange={e => setExtendStride(+e.target.value)} />                                        <div style={{ fontSize: '10px', color: '#555', marginTop: '4px' }}>Overlap for longer songs</div>                                    </div>                                </div>                            )}                        </Card>
                        {/* Song Title */}
                        <Card>
                            <CardTitle>Song Title</CardTitle>
                            <input
                                type="text"
                                value={title}
                                onChange={e => setTitle(e.target.value)}
                                placeholder="Enter song title..."
                                style={{
                                    width: '100%',
                                    backgroundColor: '#1e1e1e',
                                    border: '1px solid #3a3a3a',
                                    borderRadius: '10px',
                                    padding: '12px 14px',
                                    color: '#e0e0e0',
                                    fontSize: '14px',
                                    outline: 'none',
                                }}
                            />
                        </Card>
                    </aside>

                    {/* Main Content */}
                    <main style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        {/* Structure */}
                        <Card>
                            <CardTitle>Structure</CardTitle>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', overflowX: 'auto', paddingBottom: '4px' }}>
                                {sections.map(s => {
                                    const { base, duration } = fromApiType(s.type);
                                    const cfg = SECTION_TYPES[base] || { name: base, color: '#888' };
                                    const isResizable = cfg.hasDuration;
                                    const widths = { short: 70, medium: 100 };
                                    const currentWidth = isResizable ? widths[duration] || widths.short : null;

                                    return (
                                        <div
                                            key={s.id}
                                            draggable={!isResizable}
                                            onDragStart={e => !isResizable && handleDragStart(e, s.id)}
                                            onDragOver={handleDragOver}
                                            onDrop={e => handleDrop(e, s.id)}
                                            style={{
                                                position: 'relative',
                                                width: isResizable ? currentWidth : 'auto',
                                                padding: isResizable ? '8px 6px 8px 10px' : '8px 16px',
                                                borderRadius: '8px',
                                                backgroundColor: cfg.color + '20',
                                                border: `2px solid ${cfg.color}`,
                                                color: cfg.color,
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                cursor: isResizable ? 'default' : 'grab',
                                                whiteSpace: 'nowrap',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'space-between',
                                                boxSizing: 'border-box',
                                                flexShrink: 0,
                                            }}
                                        >
                                            <span
                                                draggable
                                                onDragStart={e => handleDragStart(e, s.id)}
                                                style={{ cursor: 'grab', display: 'flex', alignItems: 'center', gap: '4px' }}
                                            >
                                                {cfg.name}
                                                {isResizable && (
                                                    <span style={{
                                                        fontSize: '9px',
                                                        opacity: 0.6,
                                                        fontWeight: '400',
                                                    }}>
                                                        {duration === 'medium' ? '15s' : '5s'}
                                                    </span>
                                                )}
                                            </span>
                                            {isResizable && (
                                                <div
                                                    onMouseDown={(e) => {
                                                        e.preventDefault();
                                                        const startX = e.clientX;
                                                        const startWidth = currentWidth;

                                                        const onMouseMove = (moveE) => {
                                                            const delta = moveE.clientX - startX;
                                                            const newWidth = startWidth + delta;
                                                            // Snap to short or medium based on width
                                                            const threshold = (widths.short + widths.medium) / 2;
                                                            const newDuration = newWidth > threshold ? 'medium' : 'short';
                                                            if (newDuration !== duration) {
                                                                updateSection(s.id, { type: `${base}-${newDuration}` });
                                                            }
                                                        };

                                                        const onMouseUp = () => {
                                                            document.removeEventListener('mousemove', onMouseMove);
                                                            document.removeEventListener('mouseup', onMouseUp);
                                                        };

                                                        document.addEventListener('mousemove', onMouseMove);
                                                        document.addEventListener('mouseup', onMouseUp);
                                                    }}
                                                    style={{
                                                        width: '5px',
                                                        height: '16px',
                                                        marginLeft: '4px',
                                                        borderRadius: '2px',
                                                        backgroundColor: cfg.color + '50',
                                                        cursor: 'ew-resize',
                                                        display: 'flex',
                                                        flexDirection: 'column',
                                                        justifyContent: 'center',
                                                        alignItems: 'center',
                                                        gap: '2px',
                                                    }}
                                                    title={`${duration} (drag to resize)`}
                                                >
                                                    <div style={{ width: '2px', height: '2px', borderRadius: '50%', backgroundColor: cfg.color }} />
                                                    <div style={{ width: '2px', height: '2px', borderRadius: '50%', backgroundColor: cfg.color }} />
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                <button
                                    ref={addBtnRef}
                                    onClick={toggleAddMenu}
                                    style={{
                                        width: '32px',
                                        height: '32px',
                                        borderRadius: '8px',
                                        backgroundColor: '#1e1e1e',
                                        border: '2px solid #3a3a3a',
                                        color: '#666',
                                        fontSize: '18px',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        flexShrink: 0,
                                    }}
                                >+</button>
                            </div>
                        </Card>

                        {/* Section Cards */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {sections.map(s => (
                                <SectionCard key={s.id} section={s} onUpdate={u => updateSection(s.id, u)} onRemove={() => removeSection(s.id)} />
                            ))}
                        </div>
                    </main>
                </div>
            </div>

            {/* Library View */}
            <div style={{ display: activeTab === 'library' ? 'block' : 'none' }}>
                <div style={{ maxWidth: '900px', margin: '0 auto', padding: '0 24px' }}>
                    <h2 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '20px', color: '#e0e0e0' }}>
                        Your Songs ({library.filter(l => l.status === 'completed').length})
                        {(currentGenPayload || queue.length > 0) && (
                            <span style={{ color: '#6366F1', fontWeight: '400', fontSize: '14px', marginLeft: '12px' }}>
                                + {(currentGenPayload ? 1 : 0) + queue.length} pending
                            </span>
                        )}
                    </h2>
                    {library.length === 0 && queue.length === 0 && !currentGenPayload ? (
                        <div style={{ textAlign: 'center', padding: '60px', color: '#666' }}>
                            No songs generated yet. Start creating!
                        </div>
                    ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {/* Currently generating item first */}
                            {currentGenPayload && (
                                <LibraryItem
                                    key="generating"
                                    item={currentGenPayload}
                                    isGenerating={true}
                                    onStop={stopGeneration}
                                    status={status}
                                    elapsedTime={elapsedTime}
                                    estimatedTime={estimatedTime}
                                />
                            )}
                            {/* Queued items next */}
                            {queue.map((item, index) => (
                                <LibraryItem
                                    key={`queue-${index}`}
                                    item={item}
                                    isQueued={true}
                                    queuePosition={index + 1}
                                    onRemoveFromQueue={() => removeFromQueue(index)}
                                />
                            ))}
                            {/* Library items (exclude currently generating one to avoid duplicate) */}
                            {library.filter(item => !currentGenId || item.id !== currentGenId).map(item => <LibraryItem key={item.id} item={item} onDelete={() => deleteGeneration(item.id)} />)}
                        </div>
                    )}
                </div>
            </div>
            </div>
            {/* End Scrollable Content Area */}

            {/* Add Section Popup - rendered at root level */}
            {showAddMenu && (
                <div
                    className="add-section-popup"
                    style={{
                        left: addMenuPos.x,
                        top: addMenuPos.y,
                        transform: addMenuPos.openUpward ? 'translateY(-100%)' : 'none',
                    }}
                >
                    {Object.entries(SECTION_TYPES)
                        .filter(([key]) => {
                            // Only allow one intro and one outro
                            if (key === 'intro' || key === 'outro') {
                                return !sections.some(s => {
                                    const { base } = fromApiType(s.type);
                                    return base === key;
                                });
                            }
                            return true;
                        })
                        .map(([key, val]) => (
                            <button key={key} onClick={() => addSection(key)} style={{ color: val.color }}>
                                + {val.name}
                            </button>
                        ))}
                </div>
            )}

            {/* Footer - only show on Create tab */}
            <footer style={{
                backgroundColor: '#232323',
                borderTop: '1px solid #333',
                padding: '14px 24px',
                display: activeTab === 'create' ? 'flex' : 'none',
                alignItems: 'center',
                gap: '12px',
                flexShrink: 0,
            }}>
                {/* Generate / Add to Queue button */}
                <button
                    onClick={generate}
                    style={{
                        backgroundColor: '#10B981',
                        color: '#fff',
                        border: 'none',
                        borderRadius: '10px',
                        padding: '14px 28px',
                        fontSize: '15px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '8px',
                        minWidth: '130px',
                    }}
                >
                    {generating ? (
                        <>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Queue
                        </>
                    ) : 'Generate'}
                </button>

                {/* Stop button - only show when generating */}
                {generating && (
                    <button
                        onClick={stopGeneration}
                        style={{
                            backgroundColor: 'transparent',
                            color: '#EF4444',
                            border: '1px solid #EF4444',
                            borderRadius: '10px',
                            padding: '13px 20px',
                            fontSize: '14px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                        }}
                    >
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="6" width="12" height="12" rx="1"/>
                        </svg>
                        Stop
                    </button>
                )}

                {generating && (
                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '6px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '13px', color: '#ccc' }}>{status}</span>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                {queue.length > 0 && (
                                    <span
                                        style={{ fontSize: '12px', color: '#888', cursor: 'pointer' }}
                                        onClick={clearQueue}
                                        title="Click to clear queue"
                                    >
                                        {queue.length} in queue
                                    </span>
                                )}
                                <span style={{ fontSize: '13px', color: '#10B981', fontWeight: '600' }}>
                                    {estimatedTime ? formatTimeRemaining(Math.max(0, estimatedTime - elapsedTime)) : 'calculating...'}
                                </span>
                            </div>
                        </div>
                        <div
                            className="progress-bar-indeterminate"
                            style={{
                                height: '6px',
                                borderRadius: '3px',
                            }}
                        />
                    </div>
                )}

                {audio && !generating && (
                    <div style={{ flex: 1, display: 'flex', gap: '12px', alignItems: 'center' }}>
                        {audio.files?.map((f, i) => <DarkAudioPlayer key={i} src={`/api/audio/${audio.id}/${i}`} />)}
                    </div>
                )}

                {error && !generating && (
                    <div style={{ flex: 1, color: '#EF4444', fontSize: '13px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                        {error}
                    </div>
                )}
            </footer>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
